{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <!-- font awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css" integrity="sha384-REHJTs1r2ErKBuJB0fCK99gCYsVjwxHrSU0N7I1zl9vZbggVJXRMsv/sLlOAGb4M" crossorigin="anonymous">
    <!-- css -->
    <link rel="stylesheet" href="{% static 'events/main.css' %}">
    <!-- mapbox --> 
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.css' rel='stylesheet' />

    <title>myJam</title>
  </head>
  <!-- body -->
<body>
{% csrf_token %}
  <div id="background">
    <!-- main container -->
    <div id="app" class="container">
      <div class="row bg-primary justify-content-end text-center">
        <div class="col-4">
          <a href="{% url 'events-home' %}" class="navbar-brand">
            <h1 class="display-1 text-light">myJam</h1>
          </a>
        </div>
        <div class="col-4 navbar-nav">
          <a href="{% url 'locals' %}" class="nav-link"><h4 class="text-light">LocalsOnly</h4>
          
          {% if user.is_authenticated %}
            <a href="{% url 'logout' %}" class="nav-link"><h4 class="text-light">Logout</h4>
            </a>
          {% else %}
            <a href="{% url 'login' %}" class="nav-link"><h4 class="text-light">Login</h4>
            </a>
            <a href="{% url 'register' %}" class="nav-link"><h4 class="text-light">Signup!</h4>
            </a>
          {% endif %}
        </div>
      </div>
      {% block content %}    
      {% endblock content %} 
    </div>

      <!-- start mapbox -->
      {% if request.get_full_path == "/" %}
      <!-- mapbox body -->
        {% comment %} <div id='map' class='mx-auto my-5' style='width: 400px; height: 300px;'></div>
        <!-- mapbox script -->
        <script>
          mapboxgl.accessToken = 'pk.eyJ1IjoicnlhbmNvbGxpbnMyMjIiLCJhIjoiY2s1bjR6cWI1MGZ0MDNybzdsNnE3eDZ6dSJ9.l8tYMEX4SKtlXfFiz5t5uA';
          // MAPBOX CONTAINER
          // var map = new mapboxgl.Map({
          //   container: 'map',
          //   style: 'mapbox://styles/mapbox/streets-v11',
          //   zoom: 3,
          //   center: [-96, 37]
          // });

          // ADD GEOLOCATE
          // Add geolocate control to the map.
          // map.addControl(
          //   new mapboxgl.GeolocateControl({
          //     positionOptions: {
          //       enableHighAccuracy: true
          //     },
          //     trackUserLocation: true,
          //   })
          // );

            // GET CURRENT POSITION
        //   navigator.geolocation.getCurrentPosition(position => { 
        //     var map = new mapboxgl.Map({
        //   // container id specified in the HTML
        //       container: 'map',
        //     // style URL
        //       style: 'mapbox://styles/mapbox/streets-v11',
        // // initial position in [lon, lat] format

        // WHERE THE MAP CENTERS BASED ON LOCATION
        //       center: [position.coords.longitude, position.coords.latitude],
        // // initial zoom
        //       zoom: 14,
        //     });
        //   }); 
        //   var marker = new mapboxgl.Marker()
        //     .setLngLat([-21.92661562, 64.14356426])
        //     .setPopup(popup)
        //     .addTo(map); {% endcomment %}
        </script>
        <!-- end mapbox -->
      {% endif %}
  </div>


    <!-- Optional JavaScript -->
    <!-- axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- vue -->
    <script src="https://unpkg.com/vue"></script>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

  <script>
    Vue.component('concert-info', {
      props: ['event'],
      delimiters: ['[[' , ']]'],
      template: `
          <div class="col-4 text-center">
              <img :src="[[ event.images[0].url ]]" class="w-100 img-fluid" alt="Responsive image">
            <a :href="[[ event._embedded.attractions[0].externalLinks.homepage[0].url ]]"><h4 class="mt-3"> [[ event.name ]] </h4></a>
            <p class="mb-0"> [[event._embedded.venues[0].name]] </p>
            <p class="mb-0"> [[event._embedded.venues[0].address.line1]] </p>
            <p class="mb-0">
              [[event._embedded.venues[0].city.name]] , [[event._embedded.venues[0].state.stateCode]]
            </p>
            <p class="mb-0"> [[event.dates.start.localDate]] </p>
            <p> [[event.dates.start.localTime]] </p>
          </div>
      `    
      ,
    })

    let vm = new Vue({
      el: '#app',
      delimiters: ['[[' , ']]'],
      data: {
        events: null,
        newEvent: {
          band: '', 
          venue: '', 
          street_address: '',
          city: '',
          state: '',
          date: '',
          time: '',
          image: null,
        },
        localEvents: [],
        venue: '',
        city: 'Portland',
        startDate: null,
        endDate: null,
      },
      methods: {
        getEvents: function() {
          axios({
            method: 'get',
            params: {
              apikey: 'ZAfftX5BnSjZ7ipPGzYzNZ7ObbVKzTh9',
              city: this.city,
              classificationName: 'Music',
              localDate: this.startDate,
              // endLocalDate: this.endDate,
              // startDateTime: '2020-01-20T00:00:00Z',
              // endDateTime: '2020-01-26T:00:00Z',
              sort: 'date,asc'

            },
            url: 'https://app.ticketmaster.com/discovery/v2/events',
          }).then(response => {
            this.events = response.data._embedded.events
          })
        },  
        citySearch: function() {
          console.log(this.events);
          this.getEvents();
        },
        getLocals: function() {
            axios({
              method: 'GET',
              url: "apis/v1/",
              headers: {
                "X-CSRFToken": this.csrf_token
              }              
            }).then(response => this.localEvents = response.data);
        },
      },
      mounted: function() {
        this.csrf_token = document.querySelector("input[name=csrfmiddlewaretoken]").value;
        this.getEvents();
        this.getLocals();
      },
    });  
  </script>
</body>
</html>